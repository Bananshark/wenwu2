<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARæ–‡ç‰©æ™ºèƒ½ä»‹ç»ç³»ç»Ÿ</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC',sans-serif;overflow:hidden}
#arScene{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1}
#arScene a-scene{width:100%;height:100%}
.info-panel{position:fixed;top:0;right:-400px;width:400px;height:100vh;background:#fff;box-shadow:-2px 0 10px rgba(0,0,0,.2);z-index:100;transition:right .3s ease;overflow-y:auto;padding:20px}
.info-panel.show{right:0}
.info-panel h2{font-size:20px;color:#333;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #667eea}
.info-panel .info-content{color:#666;line-height:1.8;font-size:14px;margin-bottom:20px}
.info-panel .close-btn{position:absolute;top:15px;right:15px;width:30px;height:30px;border:0;background:#667eea;color:#fff;border-radius:50%;cursor:pointer;font-size:18px;line-height:30px;text-align:center}
.info-panel .close-btn:hover{background:#5568d3}
.chat-container{position:fixed;bottom:80px;right:20px;width:350px;background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:200;display:none;transition:right .3s ease,bottom .3s ease}
.chat-container.show{display:block}
.info-panel.show ~ .chat-container{right:420px}
.messages-container{height:200px;overflow-y:auto;padding:10px;background:#f9f9f9;border-radius:8px;margin-bottom:10px;display:flex;flex-direction:column;gap:8px}
.message{max-width:80%;padding:8px 12px;border-radius:12px;font-size:13px;line-height:1.5;word-wrap:break-word}
.user-message{align-self:flex-end;background:#667eea;color:#fff}
.bot-message{align-self:flex-start;background:#fff;color:#333;border:1px solid #e0e0e0}
.input-container{display:flex;gap:8px}
#userInput{flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:20px;font-size:13px;outline:0}
#userInput:focus{border-color:#667eea}
#sendButton{padding:8px 16px;border:0;border-radius:20px;background:#667eea;color:#fff;font-size:13px;cursor:pointer}
#sendButton:hover{background:#5568d3}
.chat-toggle-button{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:#667eea;border:0;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.2);z-index:201;font-size:24px;transition:right .3s ease,bottom .3s ease}
.chat-toggle-button:hover{background:#5568d3}
.chat-toggle-button.above-chat{bottom:auto;top:auto}
.info-panel.show ~ .chat-toggle-button{right:420px}
.typing-indicator{display:none;align-self:flex-start;background:#fff;padding:8px 12px;border-radius:12px;border:1px solid #e0e0e0;margin-bottom:8px;font-size:13px}
.typing-indicator.show{display:block}
.typing-dots{display:inline-flex;gap:4px;margin-left:8px}
.typing-dots span{width:6px;height:6px;background:#667eea;border-radius:50%;animation:typing 1.4s infinite}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-4px)}}
.import-buttons-container{position:absolute;top:-45px;left:0;display:none;gap:8px;z-index:201}
.import-buttons-container.show{display:flex}
.import-button{padding:8px 16px;background:#667eea;color:#fff;border:0;border-radius:20px;font-size:13px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2);white-space:nowrap}
.import-button:hover{background:#5568d3}
@media (max-width:768px){
.info-panel{width:100%;right:-100%}
.chat-container{width:calc(100% - 40px);right:20px;max-width:calc(100vw - 40px);bottom:80px}
.info-panel.show ~ .chat-container{right:20px!important}
.info-panel.show ~ .chat-toggle-button{right:20px!important}
.chat-container .import-buttons-container{top:-40px}
}
@media (max-width:480px){
.chat-container{width:calc(100% - 20px);right:10px;bottom:80px}
.chat-toggle-button{right:10px}
.info-panel.show ~ .chat-container{right:10px}
.info-panel.show ~ .chat-toggle-button{right:10px}
}
.error-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:20px}
.error-box{background:#fff;border-radius:12px;padding:30px;max-width:500px;width:100%;box-shadow:0 4px 20px rgba(0,0,0,.3);text-align:center}
.error-box h2{color:#e74c3c;margin-bottom:15px;font-size:22px}
.error-box p{color:#666;line-height:1.8;margin-bottom:20px;font-size:14px}
.error-box .error-icon{font-size:48px;margin-bottom:15px}
.error-box .action-btn{padding:12px 24px;background:#667eea;color:#fff;border:0;border-radius:20px;cursor:pointer;font-size:14px;margin:5px}
.error-box .action-btn:hover{background:#5568d3}
.error-box .action-btn.secondary{background:#95a5a6}
.error-box .action-btn.secondary:hover{background:#7f8c8d}
.error-box ul{text-align:left;color:#666;line-height:2;margin:15px 0;padding-left:20px;font-size:13px}
</style>
</head>
<body>
<div id="arScene">
<a-scene id="arSceneContainer" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
<a-assets id="assetsContainer">
<!-- æ¨¡å‹èµ„æºå°†åŠ¨æ€åŠ è½½ -->
</a-assets>
<a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
<!-- ARç›®æ ‡å®ä½“å°†åŠ¨æ€ç”Ÿæˆ -->
</a-scene>
</div>
<div class="info-panel" id="infoPanel">
<button class="close-btn" id="closeInfo">Ã—</button>
<h2 id="infoTitle">æ–‡ç‰©ä»‹ç»</h2>
<div class="info-content" id="infoContent">æ­£åœ¨åŠ è½½ä»‹ç»ä¿¡æ¯...</div>
</div>
<div class="chat-container" id="chatContainer">
<div class="import-buttons-container" id="importButtonsContainer">
<button class="import-button" id="importButton1">æŒ‰é’®1</button>
<button class="import-button" id="importButton2">æŒ‰é’®2</button>
</div>
<div class="messages-container" id="messagesContainer"></div>
<div class="typing-indicator" id="typingIndicator"><span>AIæ­£åœ¨æ€è€ƒ</span><div class="typing-dots"><span></span><span></span><span></span></div></div>
<div class="input-container">
<input type="text" id="userInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off">
<button id="sendButton">å‘é€</button>
</div>
</div>
<button class="chat-toggle-button" id="chatToggleButton" title="æ‰“å¼€èŠå¤©">ğŸ’¬</button>
<div class="error-overlay" id="errorOverlay" style="display:none">
<div class="error-box">
<div class="error-icon">âš ï¸</div>
<h2 id="errorTitle">æ‘„åƒå¤´æƒé™é—®é¢˜</h2>
<p id="errorMessage"></p>
<div id="errorActions"></div>
</div>
</div>
<script>
let artifactInfo={};
let artifactModels={};
let artifactButtons={};
let apiConfig={url:"",key:"",appId:""},isWaitingForResponse=false,currentTarget=null;
let mindFilePath="./mind/postcard&table.mind";
const scene=document.querySelector('#arSceneContainer');
const infoPanel=document.getElementById('infoPanel');
const chatContainer=document.getElementById('chatContainer');
function isHTTPS(){
return window.location.protocol==='https:'||window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'||window.location.hostname==='[::1]';
}
function showError(title,message,actions){
const overlay=document.getElementById('errorOverlay');
const titleEl=document.getElementById('errorTitle');
const messageEl=document.getElementById('errorMessage');
const actionsEl=document.getElementById('errorActions');
titleEl.textContent=title;
messageEl.innerHTML=message;
actionsEl.innerHTML='';
if(actions&&actions.length>0){
actions.forEach(action=>{
const btn=document.createElement('button');
btn.className='action-btn'+(action.secondary?' secondary':'');
btn.textContent=action.text;
btn.onclick=action.callback;
actionsEl.appendChild(btn);
});
}
overlay.style.display='flex';
}
function hideError(){
document.getElementById('errorOverlay').style.display='none';
}
async function checkCameraPermission(){
try{
const stream=await navigator.mediaDevices.getUserMedia({video:true});
stream.getTracks().forEach(track=>track.stop());
return true;
}catch(error){
console.error('æ‘„åƒå¤´æƒé™æ£€æŸ¥å¤±è´¥:',error);
return false;
}
}
async function requestCameraPermission(){
try{
const stream=await navigator.mediaDevices.getUserMedia({video:true});
stream.getTracks().forEach(track=>track.stop());
hideError();
location.reload();
return true;
}catch(error){
console.error('æ‘„åƒå¤´æƒé™è¯·æ±‚å¤±è´¥:',error);
let errorMsg='æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚';
if(error.name==='NotAllowedError'){
errorMsg='æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®æ‘„åƒå¤´ï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚';
}else if(error.name==='NotFoundError'){
errorMsg='æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡ã€‚è¯·ç¡®ä¿æ‚¨çš„è®¾å¤‡å·²è¿æ¥æ‘„åƒå¤´ã€‚';
}else if(error.name==='NotReadableError'){
errorMsg='æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚è¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨åé‡è¯•ã€‚';
}else if(error.message){
errorMsg=error.message;
}
showError('æ‘„åƒå¤´æƒé™é”™è¯¯',errorMsg,[{text:'é‡è¯•',callback:requestCameraPermission},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
return false;
}
}
function checkEnvironment(){
if(!isHTTPS()){
showError('éœ€è¦HTTPSè¿æ¥','æ‚¨çš„ç½‘ç«™éœ€è¦é€šè¿‡HTTPSåè®®è®¿é—®æ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´åŠŸèƒ½ã€‚<br><br><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><ul><li>ä½¿ç”¨HTTPSéƒ¨ç½²æ‚¨çš„ç½‘ç«™</li><li>å¦‚æœæ‚¨æ˜¯å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ï¼ˆlocalhostï¼‰</li><li>è”ç³»ç½‘ç«™ç®¡ç†å‘˜é…ç½®SSLè¯ä¹¦</li></ul>',[{text:'æˆ‘çŸ¥é“äº†',callback:hideError}]);
return false;
}
return true;
}
async function showInfo(targetIndex){
if(!artifactInfo||Object.keys(artifactInfo).length===0){
await loadConfig();
}
const info=artifactInfo[targetIndex];
if(info){
document.getElementById('infoTitle').textContent=info.title;
document.getElementById('infoContent').textContent=info.content;
infoPanel.classList.add('show');
currentTarget=targetIndex;
if(apiConfig.url&&apiConfig.key&&apiConfig.appId){
chatContainer.classList.add('show');
const toggleButton=document.getElementById('chatToggleButton');
setTimeout(()=>{
const chatHeight=chatContainer.offsetHeight;
toggleButton.style.bottom=(chatHeight+30)+'px';
},100);
}
updateImportButtons(targetIndex);
}else{
console.warn('æœªæ‰¾åˆ°ç´¢å¼•ä¸º',targetIndex,'çš„æ–‡ç‰©ä¿¡æ¯');
document.getElementById('infoTitle').textContent='æ–‡ç‰©ä»‹ç»';
document.getElementById('infoContent').textContent='æœªæ‰¾åˆ°è¯¥æ–‡ç‰©çš„ä»‹ç»ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥config.jsoné…ç½®ã€‚';
infoPanel.classList.add('show');
currentTarget=null;
if(apiConfig.url&&apiConfig.key&&apiConfig.appId){
chatContainer.classList.add('show');
const toggleButton=document.getElementById('chatToggleButton');
setTimeout(()=>{
const chatHeight=chatContainer.offsetHeight;
toggleButton.style.bottom=(chatHeight+30)+'px';
},100);
}
updateImportButtons(null);
}
}
function updateImportButtons(targetIndex){
const buttonsContainer=document.getElementById('importButtonsContainer');
const button1=document.getElementById('importButton1');
const button2=document.getElementById('importButton2');
let hasButtons=false;
if(targetIndex!==null&&artifactButtons[targetIndex]){
const buttons=artifactButtons[targetIndex];
if(buttons.button1){
button1.textContent=buttons.button1.text||'æŒ‰é’®1';
button1.dataset.content=buttons.button1.content||'';
button1.style.display='block';
hasButtons=true;
}else{
button1.style.display='none';
}
if(buttons.button2){
button2.textContent=buttons.button2.text||'æŒ‰é’®2';
button2.dataset.content=buttons.button2.content||'';
button2.style.display='block';
hasButtons=true;
}else{
button2.style.display='none';
}
}else{
button1.style.display='none';
button2.style.display='none';
}
if(hasButtons&&apiConfig.url&&apiConfig.key&&apiConfig.appId){
buttonsContainer.classList.add('show');
}else{
buttonsContainer.classList.remove('show');
}
}
function hideInfo(){
infoPanel.classList.remove('show');
document.getElementById('importButtonsContainer').classList.remove('show');
currentTarget=null;
if(!chatContainer.classList.contains('show')){
const toggleButton=document.getElementById('chatToggleButton');
toggleButton.style.bottom='20px';
}
}
function toggleChat(){
const toggleButton=document.getElementById('chatToggleButton');
if(chatContainer.classList.contains('show')){
chatContainer.classList.remove('show');
toggleButton.style.bottom='20px';
}else{
chatContainer.classList.add('show');
const chatHeight=chatContainer.offsetHeight;
toggleButton.style.bottom=(chatHeight+30)+'px';
if(document.getElementById('messagesContainer').children.length===0){
if(apiConfig.url&&apiConfig.key&&apiConfig.appId){
addMessage('ä½ å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ä¸ºæ‚¨ä»‹ç»æ–‡ç‰©çš„å†å²ã€æ–‡åŒ–èƒŒæ™¯ç­‰ä¿¡æ¯ã€‚','bot');
}else{
addMessage('è¯·å…ˆåœ¨config.jsonä¸­é…ç½®APIä¿¡æ¯ã€‚','bot');
}
}
}
}
document.getElementById('closeInfo').addEventListener('click',hideInfo);
document.getElementById('chatToggleButton').addEventListener('click',toggleChat);
document.getElementById('importButton1').addEventListener('click',function(){
const content=this.dataset.content;
if(content&&content.trim()!==''){
document.getElementById('userInput').value=content;
if(!isWaitingForResponse){
sendMessage();
}
}
});
document.getElementById('importButton2').addEventListener('click',function(){
const content=this.dataset.content;
if(content&&content.trim()!==''){
document.getElementById('userInput').value=content;
if(!isWaitingForResponse){
sendMessage();
}
}
});
async function loadConfig(){
try{
const r=await fetch('config.json?t='+Date.now(),{cache:'no-cache'});
if(!r.ok)throw new Error('é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥');
const c=await r.json();
if(c.api){
apiConfig.url=c.api.url||"";
apiConfig.key=c.api.key||"";
apiConfig.appId=c.api.appId||"";
}
if(c.mindFile&&c.mindFile.path){
mindFilePath=c.mindFile.path;
}
if(c.artifacts){
artifactInfo={};
artifactModels={};
artifactButtons={};
for(const key in c.artifacts){
const artifact=c.artifacts[key];
artifactInfo[key]={
title:artifact.title,
content:artifact.content
};
if(artifact.model){
artifactModels[key]=artifact.model;
}
if(artifact.buttons){
artifactButtons[key]=artifact.buttons;
}
}
console.log('å·²åŠ è½½æ–‡ç‰©ä¿¡æ¯:',artifactInfo);
console.log('å·²åŠ è½½æ¨¡å‹é…ç½®:',artifactModels);
console.log('å·²åŠ è½½æŒ‰é’®é…ç½®:',artifactButtons);
buildScene();
}else{
console.warn('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°artifactsä¿¡æ¯');
}
}catch(e){console.warn('é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥:',e.message);}
}
function buildScene(){
if(!scene)return;
try{
scene.setAttribute('mindar-image',`imageTargetSrc:${mindFilePath};`);
const assetsContainer=document.getElementById('assetsContainer');
const sceneEntities=scene.querySelectorAll('[mindar-image-target]');
sceneEntities.forEach(el=>el.remove());
assetsContainer.innerHTML='';
for(const key in artifactModels){
const model=artifactModels[key];
const assetItem=document.createElement('a-asset-item');
assetItem.setAttribute('id',model.id);
assetItem.setAttribute('src',model.path);
assetsContainer.appendChild(assetItem);
const targetEntity=document.createElement('a-entity');
targetEntity.setAttribute('mindar-image-target',`targetIndex: ${model.targetIndex}`);
targetEntity.setAttribute('id',`target${key}`);
const gltfModel=document.createElement('a-gltf-model');
gltfModel.setAttribute('rotation',model.rotation||'0 0 0');
gltfModel.setAttribute('position',model.position||'0 -0.25 0');
gltfModel.setAttribute('scale',model.scale||'1 1 1');
gltfModel.setAttribute('src',`#${model.id}`);
if(model.enableAnimation){
gltfModel.setAttribute('animation-mixer','');
}
targetEntity.appendChild(gltfModel);
scene.appendChild(targetEntity);
setTimeout(function(){
const targetEl=document.getElementById(`target${key}`);
if(targetEl){
targetEl.addEventListener('targetFound',function(){showInfo(key);});
targetEl.addEventListener('targetLost',function(){hideInfo();});
}
},100);
}
scene.addEventListener('arReady',function(){
console.log('ARåœºæ™¯å·²å°±ç»ª');
hideError();
});
scene.addEventListener('arError',function(event){
console.error('ARé”™è¯¯:',event.detail);
let errorMsg='ARåˆå§‹åŒ–å¤±è´¥ã€‚';
if(event.detail){
if(event.detail.includes('camera')||event.detail.includes('æ‘„åƒå¤´')){
errorMsg='æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚è¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™å’Œæµè§ˆå™¨è®¾ç½®ã€‚';
showError('æ‘„åƒå¤´è®¿é—®å¤±è´¥',errorMsg+'<br><br><strong>å¯èƒ½çš„åŸå› ï¼š</strong><ul><li>æµè§ˆå™¨æœªæˆäºˆæ‘„åƒå¤´æƒé™</li><li>æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨</li><li>æµè§ˆå™¨ä¸æ”¯æŒWebRTC</li></ul>',[{text:'è¯·æ±‚æƒé™',callback:async function(){await requestCameraPermission();}},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
return;
}
errorMsg=event.detail;
}
showError('ARåˆå§‹åŒ–é”™è¯¯',errorMsg,[{text:'é‡è¯•',callback:function(){location.reload();}},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
});
setTimeout(async function(){
const hasPermission=await checkCameraPermission();
if(!hasPermission){
showError('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»','æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚ARåŠŸèƒ½éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚<br><br><strong>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</strong><ul><li>ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡æˆ–ä¿¡æ¯å›¾æ ‡</li><li>åœ¨æƒé™è®¾ç½®ä¸­å…è®¸è®¿é—®æ‘„åƒå¤´</li><li>åˆ·æ–°é¡µé¢é‡è¯•</li></ul>',[{text:'è¯·æ±‚æƒé™',callback:requestCameraPermission},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
}
},1000);
console.log('åœºæ™¯æ„å»ºå®Œæˆ');
}catch(error){
console.error('åœºæ™¯æ„å»ºé”™è¯¯:',error);
showError('åœºæ™¯æ„å»ºå¤±è´¥',`æ„å»ºARåœºæ™¯æ—¶å‘ç”Ÿé”™è¯¯ï¼š${error.message}`,[{text:'åˆ·æ–°é¡µé¢',callback:function(){location.reload();}},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
}
}
function setupEventListeners(){
const sb=document.getElementById('sendButton'),ui=document.getElementById('userInput');
sb.addEventListener('click',sendMessage);
ui.addEventListener('keypress',function(e){if(e.key==='Enter'&&!isWaitingForResponse)sendMessage();});
}
async function sendMessage(){
const m=document.getElementById('userInput').value.trim();
if(!m)return;
if(!apiConfig.url||!apiConfig.key||!apiConfig.appId){
addMessage('è¯·å…ˆåœ¨config.jsonä¸­é…ç½®APIä¿¡æ¯ã€‚','bot');
return;
}
disableInput();
addMessage(m,'user');
document.getElementById('userInput').value='';
document.getElementById('typingIndicator').classList.add('show');
await callAPI(m);
}
async function callAPI(message){
try{
const c=new AbortController(),t=setTimeout(()=>c.abort(),60000);
const r=await fetch(apiConfig.url,{method:'POST',headers:{'Authorization':`Bearer ${apiConfig.key}`,'Content-Type':'application/json'},body:JSON.stringify({input:{prompt:message},parameters:{temperature:0.7,max_tokens:2000}}),signal:c.signal});
clearTimeout(t);
if(!r.ok)throw new Error(`APIé”™è¯¯: ${r.status} ${r.statusText}`);
const result=await r.json();
document.getElementById('typingIndicator').classList.remove('show');
let answer="æŠ±æ­‰ï¼Œæ— æ³•è§£æAPIå“åº”";
if(result.output&&result.output.text)answer=result.output.text;
else if(result.choices&&result.choices[0]&&result.choices[0].message)answer=result.choices[0].message.content;
else if(result.response)answer=result.response;
if(!answer||answer.trim()==='')answer="æŠ±æ­‰ï¼ŒAIæ²¡æœ‰è¿”å›æœ‰æ•ˆå›å¤ï¼Œè¯·é‡è¯•ã€‚";
await typeMessage(answer,'bot');
}catch(error){
document.getElementById('typingIndicator').classList.remove('show');
let em='å‘ç”ŸæœªçŸ¥é”™è¯¯';
if(error.name==='AbortError')em='è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
else if(error.message)em=error.message;
addMessage(`æŠ±æ­‰ï¼Œ${em}`,'bot');
console.error('APIè°ƒç”¨é”™è¯¯:',error);
}finally{enableInput();}
}
function addMessage(text,sender){
const e=document.createElement('div');
e.classList.add('message',sender==='user'?'user-message':'bot-message');
e.textContent=text;
document.getElementById('messagesContainer').appendChild(e);
const c=document.getElementById('messagesContainer');
c.scrollTop=c.scrollHeight;
}
function typeMessage(text,sender){
return new Promise(resolve=>{
const e=document.createElement('div');
e.classList.add('message',sender==='user'?'user-message':'bot-message');
document.getElementById('messagesContainer').appendChild(e);
let i=0;
const id=setInterval(()=>{
if(i<text.length){e.textContent+=text.charAt(i);i++;const c=document.getElementById('messagesContainer');c.scrollTop=c.scrollHeight;}
else{clearInterval(id);resolve();}
},50);
});
}
function disableInput(){document.getElementById('userInput').disabled=true;document.getElementById('sendButton').disabled=true;isWaitingForResponse=true;}
function enableInput(){document.getElementById('userInput').disabled=false;document.getElementById('sendButton').disabled=false;isWaitingForResponse=false;document.getElementById('userInput').focus();}
window.addEventListener('error',function(event){
if(event.message&&(event.message.includes('getUserMedia')||event.message.includes('camera')||event.message.includes('æ‘„åƒå¤´')||event.message.includes('permission'))){
console.error('æ•è·åˆ°æ‘„åƒå¤´ç›¸å…³é”™è¯¯:',event.message);
if(document.getElementById('errorOverlay').style.display==='none'){
showError('æ‘„åƒå¤´é”™è¯¯','æ£€æµ‹åˆ°æ‘„åƒå¤´è®¿é—®é”™è¯¯ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚',[{text:'è¯·æ±‚æƒé™',callback:requestCameraPermission},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
}
}
});
window.addEventListener('unhandledrejection',function(event){
if(event.reason&&(event.reason.name==='NotAllowedError'||event.reason.name==='NotFoundError'||event.reason.name==='NotReadableError'||event.reason.message&&(event.reason.message.includes('camera')||event.reason.message.includes('æ‘„åƒå¤´')))){
console.error('æ•è·åˆ°æœªå¤„ç†çš„æ‘„åƒå¤´é”™è¯¯:',event.reason);
event.preventDefault();
if(document.getElementById('errorOverlay').style.display==='none'){
let errorMsg='æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚';
if(event.reason.name==='NotAllowedError'){
errorMsg='æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®æ‘„åƒå¤´ã€‚';
}else if(event.reason.name==='NotFoundError'){
errorMsg='æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡ã€‚';
}else if(event.reason.name==='NotReadableError'){
errorMsg='æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚';
}
showError('æ‘„åƒå¤´è®¿é—®å¤±è´¥',errorMsg+'<br><br>è¯·åˆ·æ–°é¡µé¢å¹¶æˆäºˆæ‘„åƒå¤´æƒé™åé‡è¯•ã€‚',[{text:'è¯·æ±‚æƒé™',callback:requestCameraPermission},{text:'åˆ·æ–°é¡µé¢',callback:function(){location.reload();}},{text:'å–æ¶ˆ',callback:hideError,secondary:true}]);
}
}
});
document.addEventListener('DOMContentLoaded',async function(){
if(!checkEnvironment()){
return;
}
if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
showError('æµè§ˆå™¨ä¸æ”¯æŒ','æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®åŠŸèƒ½ã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Firefoxã€Safariæˆ–Edgeæµè§ˆå™¨ã€‚',[{text:'æˆ‘çŸ¥é“äº†',callback:hideError}]);
return;
}
await loadConfig();
setupEventListeners();
});
</script>
</body>
</html>

